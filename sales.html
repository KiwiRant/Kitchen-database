<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kitchen CRM · Sales</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Kitchen CRM</h1>
    <nav>
      <a href="dashboard.html">Dashboard</a>
      <a href="sales.html">Sales</a>
      <a href="quotes.html">Quotes</a>
      <a href="login.html">Login</a>
      <a href="create-user.html">Add User</a>
    </nav>
  </header>
  <main>
    <section class="card">
      <h2>Record a sale</h2>
      <p class="description">Log work completed for a client to keep job totals up to date.</p>
      <div id="sale-status" class="status-banner"></div>
      <form id="sale-form">
        <div class="grid two-columns">
          <div>
            <label for="clientId">Client</label>
            <select id="clientId" name="clientId" required></select>
          </div>
          <div>
            <label for="jobName">Job name</label>
            <input id="jobName" name="jobName" placeholder="Main showroom renovation" required>
          </div>
        </div>
        <div style="margin-top: 1rem;">
          <label for="description">Description</label>
          <input id="description" name="description" placeholder="Installed countertops" required>
        </div>
        <div class="grid two-columns" style="margin-top: 1rem;">
          <div>
            <label for="quantity">Quantity</label>
            <input type="number" id="quantity" name="quantity" min="1" step="0.01" value="1" required>
          </div>
          <div>
            <label for="unitPrice">Unit price</label>
            <input type="number" id="unitPrice" name="unitPrice" min="0" step="0.01" value="0" required>
          </div>
        </div>
        <button type="submit" style="margin-top: 1.5rem;">Save sale</button>
      </form>
    </section>

    <section class="card">
      <h2>Sales history</h2>
      <p class="description">All recorded items grouped by client and job.</p>
      <div id="history-status" class="status-banner"></div>
      <div class="table-wrapper">
        <table id="history-table">
          <thead>
            <tr>
              <th>Client</th>
              <th>Job</th>
              <th>Description</th>
              <th>Quantity</th>
              <th>Unit price</th>
              <th>Total</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody></tbody>
  <meta charset="UTF-8" />
  <title>Sales | Kitchen CRM</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main>
    <header class="card">
      <h1>Sales</h1>
      <nav>
        <a href="dashboard.html">Dashboard</a>
        <a href="quotes.html">Quotes</a>
        <a href="login.html" id="logoutLink">Logout</a>
      </nav>
      <p>Record sales against client jobs and keep everything grouped in one place.</p>
    </header>

    <section class="flex">
      <div class="card">
        <h2>Record a sale</h2>
        <form id="saleForm">
          <label>
            Client
            <select id="saleClient" required></select>
          </label>
          <label>
            Job name
            <input type="text" id="jobName" list="jobSuggestions" placeholder="Kitchen renovation" required />
            <datalist id="jobSuggestions"></datalist>
          </label>
          <label>
            Description
            <textarea id="description" rows="3" placeholder="Describe the work completed" required></textarea>
          </label>
          <label>
            Amount
            <input type="number" id="amount" step="0.01" min="0" placeholder="0.00" required />
          </label>
          <label>
            Sale date
            <input type="date" id="saleDate" />
          </label>
          <button type="submit">Save sale</button>
          <p id="saleMessage"></p>
        </form>
      </div>

      <div class="card">
        <h2>Add a client</h2>
        <form id="clientForm">
          <input type="text" id="clientName" placeholder="Client name" required />
          <input type="email" id="clientEmail" placeholder="Email" />
          <input type="tel" id="clientPhone" placeholder="Phone" />
          <textarea id="clientAddress" rows="3" placeholder="Address"></textarea>
          <button type="submit">Create client</button>
          <p id="clientMessage"></p>
        </form>
        <small>Clients and job names are used to group sales when generating quotes.</small>
      </div>
    </section>

    <section class="card">
      <div class="flex" style="align-items: center;">
        <div>
          <h2>Sales history</h2>
          <p class="badge" id="salesSummary">Select a client and job to view sales.</p>
        </div>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Sale date</th>
              <th>Description</th>
              <th>Amount</th>
            </tr>
          </thead>
          <tbody id="salesBody">
            <tr><td colspan="3">No sales to show yet.</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>
  <script>
    const saleForm = document.getElementById('sale-form');
    const saleStatus = document.getElementById('sale-status');
    const historyStatus = document.getElementById('history-status');
    const clientSelect = document.getElementById('clientId');
    const historyTableBody = document.querySelector('#history-table tbody');

    function showStatus(el, message, type = 'info') {
      el.textContent = message;
      el.className = `status-banner show ${type}`;
    }

    function hideStatus(el) {
      el.textContent = '';
      el.className = 'status-banner';
    }

    function currency(value) {
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value || 0);
    }

    function formatDate(value) {
      return value ? new Date(value).toLocaleString() : '—';
    }

    async function fetchJson(url, options) {
      const response = await fetch(url, options);
      const data = await response.json().catch(() => ({}));
      if (!response.ok) {
        throw new Error(data.error || `Request failed (${response.status})`);
      }
      return data;
    }

    async function loadClients() {
      showStatus(saleStatus, 'Loading clients…', 'info');
      const { clients } = await fetchJson('/api/clients');
      clientSelect.innerHTML = clients.length
        ? clients.map((client) => `<option value="${client.id}">${client.name}</option>`).join('')
        : '<option value="">No clients yet</option>';
      hideStatus(saleStatus);
      if (!clients.length) {
        showStatus(saleStatus, 'Add a client from the dashboard before recording sales.', 'info');
      }
    }

    async function loadSales() {
      showStatus(historyStatus, 'Loading sales…', 'info');
      const { sales } = await fetchJson('/api/sales');
      historyTableBody.innerHTML = sales.length
        ? sales.map((sale) => `
            <tr>
              <td>${sale.clientName || 'Unknown client'}</td>
              <td>${sale.jobName}</td>
              <td>${sale.description}</td>
              <td>${Number(sale.quantity).toLocaleString()}</td>
              <td>${currency(sale.unitPrice)}</td>
              <td>${currency(sale.total)}</td>
              <td>${formatDate(sale.createdAt)}</td>
            </tr>
          `).join('')
        : '<tr><td colspan="7">No sales recorded yet.</td></tr>';
      hideStatus(historyStatus);
    }

    saleForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      showStatus(saleStatus, 'Saving sale…', 'info');
      const payload = {
        clientId: saleForm.clientId.value,
        jobName: saleForm.jobName.value,
        description: saleForm.description.value,
        quantity: saleForm.quantity.value,
        unitPrice: saleForm.unitPrice.value,
      };

      try {
        await fetchJson('/api/sales', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        showStatus(saleStatus, 'Sale saved successfully.', 'success');
        saleForm.reset();
        loadSales();
      } catch (error) {
        showStatus(saleStatus, error.message, 'error');
      }
    });

    (async () => {
      try {
        await loadClients();
        await loadSales();
      } catch (error) {
        showStatus(saleStatus, error.message, 'error');
      }
    })();

  <script>
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) {
      window.location.href = "/login.html";
    }

    document.getElementById("logoutLink").addEventListener("click", () => {
      localStorage.removeItem("user");
    });

    const state = {
      clients: [],
      selectedClientId: null,
    };

    async function loadClients() {
      const res = await fetch("/api/clients");
      const data = await res.json().catch(() => ({ success: false }));
      if (!data.success) {
        document.getElementById("clientMessage").textContent = "Unable to load clients";
        return;
      }
      state.clients = data.clients;
      populateClientSelect();
    }

    function populateClientSelect() {
      const select = document.getElementById("saleClient");
      select.innerHTML = "";

      if (!state.clients.length) {
        const option = document.createElement("option");
        option.value = "";
        option.textContent = "Create a client first";
        select.appendChild(option);
        select.disabled = true;
        return;
      }

      select.disabled = false;
      for (const client of state.clients) {
        const option = document.createElement("option");
        option.value = client.id;
        option.textContent = client.name;
        select.appendChild(option);
      }

      if (!state.selectedClientId) {
        state.selectedClientId = select.value;
      }

      select.value = state.selectedClientId;
      updateJobSuggestions();
      updateSalesSummary();
    }

    function updateJobSuggestions() {
      const datalist = document.getElementById("jobSuggestions");
      datalist.innerHTML = "";
      const client = state.clients.find(c => String(c.id) === String(state.selectedClientId));
      if (!client) return;
      const jobNames = Array.from(new Set(client.jobs.map(job => job.job_name)));
      for (const name of jobNames) {
        const option = document.createElement("option");
        option.value = name;
        datalist.appendChild(option);
      }
    }

    function updateSalesSummary(total = 0, count = 0, jobName = "") {
      const summary = document.getElementById("salesSummary");
      if (!state.selectedClientId) {
        summary.textContent = "Create a client to begin recording sales.";
        return;
      }
      if (!jobName) {
        summary.textContent = "Choose or enter a job name to see sales.";
        return;
      }
      summary.textContent = `${count} sale${count === 1 ? "" : "s"} recorded · Total £${total.toFixed(2)}`;
    }

    async function loadSales() {
      const jobName = document.getElementById("jobName").value.trim();
      if (!state.selectedClientId || !jobName) {
        renderSales([]);
        updateSalesSummary();
        return;
      }

      const query = new URLSearchParams({
        client_id: state.selectedClientId,
        job_name: jobName,
      });
      const res = await fetch(`/api/sales?${query.toString()}`);
      const data = await res.json().catch(() => ({ success: false, sales: [] }));
      if (!data.success) {
        document.getElementById("saleMessage").textContent = "Unable to load sales";
        return;
      }
      renderSales(data.sales);
    }

    function renderSales(sales) {
      const tbody = document.getElementById("salesBody");
      tbody.innerHTML = "";

      if (!sales.length) {
        const row = document.createElement("tr");
        const cell = document.createElement("td");
        cell.colSpan = 3;
        cell.textContent = "No sales to show yet.";
        row.appendChild(cell);
        tbody.appendChild(row);
        updateSalesSummary(0, 0, document.getElementById("jobName").value.trim());
        return;
      }

      let total = 0;
      for (const sale of sales) {
        total += Number(sale.amount || 0);
        const row = document.createElement("tr");
        const dateCell = document.createElement("td");
        const descriptionCell = document.createElement("td");
        const amountCell = document.createElement("td");

        const date = sale.sale_date ? new Date(sale.sale_date) : null;
        dateCell.textContent = date ? date.toLocaleDateString() : "-";
        descriptionCell.textContent = sale.description;
        amountCell.textContent = `£${Number(sale.amount).toFixed(2)}`;

        row.append(dateCell, descriptionCell, amountCell);
        tbody.appendChild(row);
      }

      updateSalesSummary(total, sales.length, document.getElementById("jobName").value.trim());
    }

    document.getElementById("saleClient").addEventListener("change", (event) => {
      state.selectedClientId = event.target.value;
      updateJobSuggestions();
      loadSales();
    });

    document.getElementById("jobName").addEventListener("input", () => {
      loadSales();
    });

    document.getElementById("saleForm").addEventListener("submit", async (event) => {
      event.preventDefault();
      const message = document.getElementById("saleMessage");
      message.textContent = "";
      message.className = "";

      if (!state.selectedClientId) {
        message.textContent = "Please create a client before recording sales.";
        return;
      }

      const payload = {
        client_id: state.selectedClientId,
        job_name: document.getElementById("jobName").value.trim(),
        description: document.getElementById("description").value.trim(),
        amount: document.getElementById("amount").value,
        sale_date: document.getElementById("saleDate").value || null,
      };

      const res = await fetch("/api/sales", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const data = await res.json().catch(() => ({ success: false }));
      if (!data.success) {
        message.textContent = data.message || "Unable to save sale.";
        message.className = "";
        return;
      }

      const client = state.clients.find(c => String(c.id) === String(state.selectedClientId));
      if (client) {
        const job = client.jobs.find(j => j.job_name === payload.job_name);
        const amountValue = Number(payload.amount || 0);
        if (job) {
          job.sale_count += 1;
          job.total_amount = Number(job.total_amount || 0) + amountValue;
        } else {
          client.jobs.push({ job_name: payload.job_name, sale_count: 1, total_amount: amountValue });
        }
      }

      message.textContent = "Sale recorded!";
      message.className = "success-text";
      (event.target).reset();
      updateJobSuggestions();
      await loadSales();
    });

    document.getElementById("clientForm").addEventListener("submit", async (event) => {
      event.preventDefault();
      const message = document.getElementById("clientMessage");
      message.textContent = "";
      message.className = "";

      const payload = {
        name: document.getElementById("clientName").value.trim(),
        email: document.getElementById("clientEmail").value.trim() || null,
        phone: document.getElementById("clientPhone").value.trim() || null,
        address: document.getElementById("clientAddress").value.trim() || null,
      };

      const res = await fetch("/api/clients", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const data = await res.json().catch(() => ({ success: false }));
      if (!data.success) {
        message.textContent = data.message || "Unable to save client.";
        message.className = "";
        return;
      }

      message.textContent = "Client added!";
      message.className = "success-text";
      event.target.reset();
      state.selectedClientId = data.client.id;
      await loadClients();
      document.getElementById("saleClient").value = state.selectedClientId;
      updateJobSuggestions();
      loadSales();
    });

    loadClients().then(() => {
      state.selectedClientId = document.getElementById("saleClient").value;
      loadSales();
    });
  </script>
</body>
</html>
