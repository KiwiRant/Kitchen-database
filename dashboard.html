<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kitchen CRM · Dashboard</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Kitchen CRM</h1>
    <nav>
      <a href="dashboard.html">Dashboard</a>
      <a href="sales.html">Sales</a>
      <a href="quotes.html">Quotes</a>
      <a href="login.html">Login</a>
      <a href="create-user.html">Add User</a>
    </nav>
  </header>
  <main>
    <section class="card">
      <h2>Add a client</h2>
      <p class="description">Capture client details so the team can start logging sales.</p>
      <div id="client-form-status" class="status-banner"></div>
      <form id="client-form">
        <div class="grid two-columns">
          <div>
            <label for="client-name">Client name</label>
            <input id="client-name" name="name" placeholder="Acme Kitchens" required>
          </div>
          <div>
            <label for="client-email">Contact email</label>
            <input id="client-email" name="email" type="email" placeholder="contact@acme.com">
          </div>
        </div>
        <div class="grid two-columns" style="margin-top: 1rem;">
          <div>
            <label for="client-phone">Contact phone</label>
            <input id="client-phone" name="phone" placeholder="(555) 123-4567">
          </div>
          <div>
            <label for="client-notes">Notes</label>
            <input id="client-notes" name="notes" placeholder="Preferred install days, site access info…">
          </div>
        </div>
        <button type="submit" style="margin-top: 1.5rem;">Save client</button>
      </form>
    </section>

    <section class="card">
      <h2>Overview</h2>
      <p class="description">Track recent activity, open jobs, and quote performance at a glance.</p>
      <div class="grid two-columns" id="summary"></div>
    </section>

    <section class="card">
      <h2>Recent clients</h2>
      <p class="description">Latest organisations added to the workspace.</p>
      <div id="clients-status" class="status-banner"></div>
      <div class="table-wrapper">
        <table id="clients-table">
          <thead>
            <tr>
              <th>Client</th>
              <th>Jobs</th>
              <th>Total sales</th>
              <th>Contact</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <h2>Recent sales</h2>
      <p class="description">Latest recorded work items across all clients.</p>
      <div id="sales-status" class="status-banner"></div>
      <div class="table-wrapper">
        <table id="sales-table">
          <thead>
            <tr>
              <th>Client</th>
              <th>Job</th>
              <th>Description</th>
              <th>Total</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>
  <script>
    const summaryEl = document.getElementById('summary');
    const clientForm = document.getElementById('client-form');
    const clientFormStatus = document.getElementById('client-form-status');
    const clientsTableBody = document.querySelector('#clients-table tbody');
    const salesTableBody = document.querySelector('#sales-table tbody');
    const clientsStatus = document.getElementById('clients-status');
    const salesStatus = document.getElementById('sales-status');

    function showStatus(el, message, type = 'info') {
      el.textContent = message;
      el.className = `status-banner show ${type}`;
    }

    function hideStatus(el) {
      el.textContent = '';
      el.className = 'status-banner';
    }

    function currency(value) {
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value || 0);
    }

    function formatDate(value) {
      return value ? new Date(value).toLocaleString() : '—';
    }

    async function fetchJson(url) {
      const response = await fetch(url);
      if (!response.ok) {
        const data = await response.json().catch(() => ({}));
        throw new Error(data.error || `Request failed (${response.status})`);
      }
      return response.json();
    }

    async function loadDashboard() {
      try {
        showStatus(clientsStatus, 'Loading clients…', 'info');
        showStatus(salesStatus, 'Loading sales…', 'info');

        const [clientsData, salesData, quotesData] = await Promise.all([
          fetchJson('/api/clients'),
          fetchJson('/api/sales'),
          fetchJson('/api/quote'),
        ]);

        const clients = clientsData.clients || [];
        const sales = salesData.sales || [];
        const quotes = quotesData.quotes || [];

        const totalSales = sales.reduce((sum, sale) => sum + Number(sale.total || 0), 0);
        const totalQuotes = quotes.reduce((sum, quote) => sum + Number(quote.total || 0), 0);

        summaryEl.innerHTML = `
          <div class="summary-metric">
            <h3>Clients</h3>
            <p>${clients.length}</p>
          </div>
          <div class="summary-metric">
            <h3>Sales recorded</h3>
            <p>${currency(totalSales)}</p>
          </div>
          <div class="summary-metric">
            <h3>Quotes issued</h3>
            <p>${currency(totalQuotes)}</p>
          </div>
          <div class="summary-metric">
            <h3>Open quotes</h3>
            <p>${quotes.length}</p>
          </div>
        `;

        clientsTableBody.innerHTML = clients.slice(0, 6).map((client) => `
          <tr>
            <td>
              <strong>${client.name}</strong><br>
              <span class="muted">${client.notes || ''}</span>
            </td>
            <td>${client.jobCount || 0}</td>
            <td>${currency(client.totalSales || 0)}</td>
            <td>
              ${client.email ? `<div>${client.email}</div>` : ''}
              ${client.phone ? `<div>${client.phone}</div>` : ''}
            </td>
          </tr>
        `).join('') || '<tr><td colspan="4">No clients yet.</td></tr>';

        salesTableBody.innerHTML = sales.slice(0, 8).map((sale) => `
          <tr>
            <td>${sale.clientName || 'Unknown client'}</td>
            <td>${sale.jobName}</td>
            <td>${sale.description}</td>
            <td>${currency(sale.total)}</td>
            <td>${formatDate(sale.createdAt)}</td>
          </tr>
        `).join('') || '<tr><td colspan="5">No sales recorded yet.</td></tr>';

        hideStatus(clientsStatus);
        hideStatus(salesStatus);
      } catch (error) {
        showStatus(clientsStatus, error.message, 'error');
        showStatus(salesStatus, error.message, 'error');
      }
    }

    clientForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      showStatus(clientFormStatus, 'Saving client…', 'info');
      const payload = {
        name: document.getElementById('client-name').value,
        email: document.getElementById('client-email').value,
        phone: document.getElementById('client-phone').value,
        notes: document.getElementById('client-notes').value,
      };

      try {
        await fetchJson('/api/clients', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        showStatus(clientFormStatus, 'Client saved successfully.', 'success');
        clientForm.reset();
        loadDashboard();
      } catch (error) {
        showStatus(clientFormStatus, error.message, 'error');
      }
    });

    loadDashboard();
  </script>
</body>
</html>
