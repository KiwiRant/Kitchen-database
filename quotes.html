<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kitchen CRM · Quotes</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Kitchen CRM</h1>
    <nav>
      <a href="dashboard.html">Dashboard</a>
      <a href="sales.html">Sales</a>
      <a href="quotes.html">Quotes</a>
      <a href="login.html">Login</a>
      <a href="create-user.html">Add User</a>
    </nav>
  </header>
  <main>
    <section class="card">
      <h2>Create a quote</h2>
      <p class="description">Select a job to convert its recorded sales into a draft quote.</p>
      <div id="quote-status" class="status-banner"></div>
      <form id="quote-form">
        <div class="grid two-columns">
          <div>
            <label for="quote-client">Client</label>
            <select id="quote-client" required></select>
          </div>
          <div>
            <label for="quote-job">Job</label>
            <select id="quote-job" required></select>
          </div>
        </div>
        <div style="margin-top: 1rem;">
          <label for="quote-notes">Notes</label>
          <textarea id="quote-notes" placeholder="Add optional notes for the client"></textarea>
        </div>
        <button type="submit" style="margin-top: 1.5rem;">Generate quote</button>
      </form>
    </section>

    <section class="card">
      <h2>Quotes</h2>
      <p class="description">All generated quotes remain in draft for editing before sending.</p>
      <div id="quotes-status" class="status-banner"></div>
      <div class="table-wrapper">
        <table id="quotes-table">
          <thead>
            <tr>
              <th>Client</th>
              <th>Job</th>
              <th>Total</th>
              <th>Items</th>
              <th>Status</th>
              <th>Created</th>
            </tr>
          </thead>
          <tbody></tbody>
  <meta charset="UTF-8" />
  <title>Quotes | Kitchen CRM</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <main>
    <header class="card">
      <h1>Quotes</h1>
      <nav>
        <a href="dashboard.html">Dashboard</a>
        <a href="sales.html">Sales</a>
        <a href="login.html" id="logoutLink">Logout</a>
      </nav>
      <p>Turn a job's recorded sales into a quote to send to the client.</p>
    </header>

    <section class="card">
      <h2>Generate a quote</h2>
      <form id="quoteForm" class="flex">
        <div>
          <label>
            Client
            <select id="quoteClient" required></select>
          </label>
        </div>
        <div>
          <label>
            Job name
            <input type="text" id="quoteJob" list="quoteJobSuggestions" placeholder="Kitchen renovation" required />
            <datalist id="quoteJobSuggestions"></datalist>
          </label>
        </div>
        <div class="flex" style="flex-direction: column;">
          <label>
            Notes
            <textarea id="quoteNotes" rows="3" placeholder="Optional message for the client"></textarea>
          </label>
          <button type="submit" style="align-self: flex-start;">Create quote</button>
        </div>
      </form>
      <p id="quoteMessage"></p>

      <div class="card" style="box-shadow: none; padding: 1rem 0 0;">
        <h3 style="margin-top: 0;">Sales for this job</h3>
        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Description</th>
                <th>Amount</th>
              </tr>
            </thead>
            <tbody id="quoteSalesBody">
              <tr><td colspan="3">Choose a client and job to preview sales.</td></tr>
            </tbody>
          </table>
        </div>
        <p id="quoteSalesSummary" class="badge"></p>
      </div>
    </section>

    <section class="card">
      <h2>Recent quotes</h2>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>Created</th>
              <th>Client</th>
              <th>Job</th>
              <th>Total</th>
              <th>Line items</th>
            </tr>
          </thead>
          <tbody id="quotesBody">
            <tr><td colspan="5">No quotes yet. Generate one above.</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>
  <script>
    const quoteForm = document.getElementById('quote-form');
    const quoteStatus = document.getElementById('quote-status');
    const quotesStatus = document.getElementById('quotes-status');
    const quotesTableBody = document.querySelector('#quotes-table tbody');
    const clientSelect = document.getElementById('quote-client');
    const jobSelect = document.getElementById('quote-job');

    let salesByClient = new Map();

    function showStatus(el, message, type = 'info') {
      el.textContent = message;
      el.className = `status-banner show ${type}`;
    }

    function hideStatus(el) {
      el.textContent = '';
      el.className = 'status-banner';
    }

    function currency(value) {
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value || 0);
    }

    function formatDate(value) {
      return value ? new Date(value).toLocaleString() : '—';
    }

    function populateJobs(clientId) {
      const jobs = salesByClient.get(clientId) || [];
      jobSelect.innerHTML = jobs.length
        ? jobs.map((job) => `<option value="${job}">${job}</option>`).join('')
        : '<option value="">No jobs for this client</option>';
      jobSelect.disabled = !jobs.length;
    }

    async function fetchJson(url, options) {
      const response = await fetch(url, options);
      const data = await response.json().catch(() => ({}));
      if (!response.ok) {
        throw new Error(data.error || `Request failed (${response.status})`);
      }
      return data;
    }

    async function loadClientsAndSales() {
      showStatus(quoteStatus, 'Loading clients…', 'info');
      const [clientsData, salesData] = await Promise.all([
        fetchJson('/api/clients'),
        fetchJson('/api/sales'),
      ]);

      const clients = clientsData.clients || [];
      const sales = salesData.sales || [];

      clientSelect.innerHTML = clients.length
        ? clients.map((client) => `<option value="${client.id}">${client.name}</option>`).join('')
        : '<option value="">No clients available</option>';

      salesByClient = new Map();
      for (const sale of sales) {
        if (!salesByClient.has(String(sale.clientId))) {
          salesByClient.set(String(sale.clientId), []);
        }
        const jobs = salesByClient.get(String(sale.clientId));
        if (!jobs.includes(sale.jobName)) {
          jobs.push(sale.jobName);
        }
      }

      if (clients.length) {
        populateJobs(String(clients[0].id));
      } else {
        jobSelect.innerHTML = '<option value="">No jobs</option>';
        jobSelect.disabled = true;
      }

      hideStatus(quoteStatus);
      if (!clients.length) {
        showStatus(quoteStatus, 'Add a client and sales before generating quotes.', 'info');
      }
    }

    async function loadQuotes() {
      showStatus(quotesStatus, 'Loading quotes…', 'info');
      const { quotes } = await fetchJson('/api/quote');
      quotesTableBody.innerHTML = quotes.length
        ? quotes.map((quote) => `
            <tr>
              <td>${quote.clientName || 'Unknown client'}</td>
              <td>${quote.jobName}</td>
              <td>${currency(quote.total)}</td>
              <td>${quote.details.length}</td>
              <td><span class="badge">${quote.status || 'draft'}</span></td>
              <td>${formatDate(quote.createdAt)}</td>
            </tr>
          `).join('')
        : '<tr><td colspan="6">No quotes yet.</td></tr>';
      hideStatus(quotesStatus);
    }

    clientSelect.addEventListener('change', () => {
      populateJobs(clientSelect.value);
    });

    quoteForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      showStatus(quoteStatus, 'Generating quote…', 'info');
      const payload = {
        clientId: clientSelect.value,
        jobName: jobSelect.value,
        notes: document.getElementById('quote-notes').value,
      };

      try {
        await fetchJson('/api/quote', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        showStatus(quoteStatus, 'Quote created successfully.', 'success');
        await loadQuotes();
      } catch (error) {
        showStatus(quoteStatus, error.message, 'error');
      }
    });

    (async () => {
      try {
        await loadClientsAndSales();
        await loadQuotes();
      } catch (error) {
        showStatus(quoteStatus, error.message, 'error');
      }
    })();

  <script>
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) {
      window.location.href = "/login.html";
    }

    document.getElementById("logoutLink").addEventListener("click", () => {
      localStorage.removeItem("user");
    });

    const state = {
      clients: [],
      quotes: [],
      selectedClientId: null,
      currentSales: [],
    };

    async function loadClients() {
      const res = await fetch("/api/clients");
      const data = await res.json().catch(() => ({ success: false }));
      if (!data.success) {
        document.getElementById("quoteMessage").textContent = "Unable to load clients.";
        return;
      }
      state.clients = data.clients;
      populateClientSelect();
    }

    function populateClientSelect() {
      const select = document.getElementById("quoteClient");
      select.innerHTML = "";

      if (!state.clients.length) {
        select.disabled = true;
        const option = document.createElement("option");
        option.value = "";
        option.textContent = "Create a client first";
        select.appendChild(option);
        return;
      }

      select.disabled = false;
      for (const client of state.clients) {
        const option = document.createElement("option");
        option.value = client.id;
        option.textContent = client.name;
        select.appendChild(option);
      }

      if (!state.selectedClientId) {
        state.selectedClientId = select.value;
      }
      select.value = state.selectedClientId;
      updateJobSuggestions();
    }

    function updateJobSuggestions() {
      const datalist = document.getElementById("quoteJobSuggestions");
      datalist.innerHTML = "";
      const client = state.clients.find(c => String(c.id) === String(state.selectedClientId));
      if (!client) return;
      const jobNames = Array.from(new Set(client.jobs.map(job => job.job_name)));
      for (const name of jobNames) {
        const option = document.createElement("option");
        option.value = name;
        datalist.appendChild(option);
      }
    }

    async function loadSalesPreview() {
      const job = document.getElementById("quoteJob").value.trim();
      const summary = document.getElementById("quoteSalesSummary");
      const body = document.getElementById("quoteSalesBody");
      summary.textContent = "";
      body.innerHTML = "";

      if (!state.selectedClientId || !job) {
        const row = document.createElement("tr");
        const cell = document.createElement("td");
        cell.colSpan = 3;
        cell.textContent = "Choose a client and job to preview sales.";
        row.appendChild(cell);
        body.appendChild(row);
        summary.textContent = "";
        state.currentSales = [];
        return;
      }

      const res = await fetch(`/api/sales?client_id=${state.selectedClientId}&job_name=${encodeURIComponent(job)}`);
      const data = await res.json().catch(() => ({ success: false, sales: [] }));
      if (!data.success) {
        const row = document.createElement("tr");
        const cell = document.createElement("td");
        cell.colSpan = 3;
        cell.textContent = "Unable to load sales for this job.";
        row.appendChild(cell);
        body.appendChild(row);
        summary.textContent = "";
        state.currentSales = [];
        return;
      }

      state.currentSales = data.sales;
      renderSalesPreview();
    }

    function renderSalesPreview() {
      const body = document.getElementById("quoteSalesBody");
      const summary = document.getElementById("quoteSalesSummary");
      body.innerHTML = "";

      if (!state.currentSales.length) {
        const row = document.createElement("tr");
        const cell = document.createElement("td");
        cell.colSpan = 3;
        cell.textContent = "No sales recorded yet.";
        row.appendChild(cell);
        body.appendChild(row);
        summary.textContent = "";
        return;
      }

      let total = 0;
      for (const sale of state.currentSales) {
        total += Number(sale.amount || 0);
        const row = document.createElement("tr");
        const dateCell = document.createElement("td");
        const descriptionCell = document.createElement("td");
        const amountCell = document.createElement("td");
        const date = sale.sale_date ? new Date(sale.sale_date) : null;
        dateCell.textContent = date ? date.toLocaleDateString() : "-";
        descriptionCell.textContent = sale.description;
        amountCell.textContent = `£${Number(sale.amount).toFixed(2)}`;
        row.append(dateCell, descriptionCell, amountCell);
        body.appendChild(row);
      }

      summary.textContent = `${state.currentSales.length} sale${state.currentSales.length === 1 ? "" : "s"} · Total £${total.toFixed(2)}`;
    }

    async function loadQuotes() {
      const res = await fetch("/api/quote");
      const data = await res.json().catch(() => ({ success: false, quotes: [] }));
      if (!data.success) {
        document.getElementById("quoteMessage").textContent = "Unable to load quotes.";
        return;
      }
      state.quotes = data.quotes;
      renderQuotes();
    }

    function renderQuotes() {
      const tbody = document.getElementById("quotesBody");
      tbody.innerHTML = "";

      if (!state.quotes.length) {
        const row = document.createElement("tr");
        const cell = document.createElement("td");
        cell.colSpan = 5;
        cell.textContent = "No quotes yet. Generate one above.";
        row.appendChild(cell);
        tbody.appendChild(row);
        return;
      }

      for (const quote of state.quotes) {
        const row = document.createElement("tr");
        const createdCell = document.createElement("td");
        const clientCell = document.createElement("td");
        const jobCell = document.createElement("td");
        const totalCell = document.createElement("td");
        const itemsCell = document.createElement("td");

        const created = quote.created_at ? new Date(quote.created_at) : null;
        createdCell.textContent = created ? created.toLocaleString() : "-";
        clientCell.textContent = quote.client_name || "-";
        jobCell.textContent = quote.job_name;
        totalCell.textContent = `£${Number(quote.total_amount).toFixed(2)}`;

        const list = document.createElement("ul");
        list.style.margin = "0";
        list.style.paddingLeft = "1.1rem";
        const items = Array.isArray(quote.items) ? quote.items : [];
        for (const item of items) {
          const li = document.createElement("li");
          li.textContent = `${item.description} (£${Number(item.amount).toFixed(2)})`;
          list.appendChild(li);
        }
        if (!items.length) {
          const li = document.createElement("li");
          li.textContent = "No items stored";
          list.appendChild(li);
        }
        itemsCell.appendChild(list);

        row.append(createdCell, clientCell, jobCell, totalCell, itemsCell);
        tbody.appendChild(row);
      }
    }

    document.getElementById("quoteClient").addEventListener("change", (event) => {
      state.selectedClientId = event.target.value;
      updateJobSuggestions();
      loadSalesPreview();
    });

    document.getElementById("quoteJob").addEventListener("input", () => {
      loadSalesPreview();
    });

    document.getElementById("quoteForm").addEventListener("submit", async (event) => {
      event.preventDefault();
      const message = document.getElementById("quoteMessage");
      message.textContent = "";
      message.className = "";

      if (!state.selectedClientId) {
        message.textContent = "Please create a client first.";
        return;
      }

      if (!state.currentSales.length) {
        message.textContent = "There are no sales for this job yet.";
        return;
      }

      const payload = {
        client_id: state.selectedClientId,
        job_name: document.getElementById("quoteJob").value.trim(),
        notes: document.getElementById("quoteNotes").value.trim(),
      };

      const res = await fetch("/api/quote", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const data = await res.json().catch(() => ({ success: false }));
      if (!data.success) {
        message.textContent = data.message || "Unable to create quote.";
        return;
      }

      message.textContent = "Quote created!";
      message.className = "success-text";
      document.getElementById("quoteNotes").value = "";
      await loadQuotes();
    });

    loadClients().then(() => {
      state.selectedClientId = document.getElementById("quoteClient").value;
      loadSalesPreview();
    });
    loadQuotes();
  </script>
</body>
</html>
